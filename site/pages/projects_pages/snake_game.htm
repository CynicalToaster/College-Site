<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Snake Game - College Site</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans">
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Pacifico">
        <link rel="stylesheet" type="text/css" href="/site/resources/css/font-awesome-4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="/site/resources/css/web_structure.css"/>
        <link rel="stylesheet" type="text/css" href="/site/pages/page_themes/home.css"/>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    </head>
    <body>
        <div id="page" class="container">
            <? renderPartial('pages/page_headers/home') ?>
            <div id="content">
                <div class="row">
                    <div class="offset-a4-1 col-a4-10">
                        <div class="offset-a2-2 col-a2-8">
                            <div class="row">
                                <div id="breadcrumbs">
                                    <ul>
                                        <li class="breadcrumbs-crumb">
                                            <a href="/home">Home</a>
                                            <i class="fa fa-angle-right" aria-hidden="true"></i>
                                        </li>
                                        <li class="breadcrumbs-crumb">
                                            <a href="/projects">Projects</a>
                                            <i class="fa fa-angle-right" aria-hidden="true"></i>
                                        </li>
                                        <li class="breadcrumbs-active">Snake Game</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-a3-12">
                                <div class="panel">
                                    <div class="panel-header">
                                        <h1 class="pl-20">Snake Game</h1>
                                    </div>

                                    <style>
                                        #snake-canvas {
                                            width: 400px; 
                                            height: 400px; 
                                            border: 1px solid #ddd; 
                                            box-shadow: 0px 0px 4px -2px #000;
                                        }

                                        #snake-canvas:active {
                                            border: 1px solid #000; 
                                        }
                                    </style>
                                    
                                    <div class="row">
                                        <canvas id="snake-canvas" class="mb-10" width="400" height="400" />
                                    </div>
                                    <div class="row">
                                        <p class="pr-20">Score: <span id="snake-score">0</span></p>
                                        <p class="pr-20">High Score: <span id="snake-highscore">0</span></p>
                                        <p>Speed: <span id="snake-speed">0</span></p>
                                        <script>
                                            $('#snake-canvas').ready(function() {
                                                var canvas = document.getElementById("snake-canvas");
                                                var ctx = canvas.getContext('2d');

                                                var board_size = {x:20,y:20};
                                                var snake = [{x:Math.round(board_size.x * 0.5),y:Math.round(board_size.y * 0.5)},{x:0,y:0},{x:0,y:0},{x:0,y:0}];
                                                var snake_draw = [];//[].concat(snake);
                                                var food = [{x:10,y:20}];
                                                var snake_direction = {x:0,y:0};
                                                var scale = {x:canvas.width / board_size.x,y:canvas.height / board_size.y};
                                                var keys = [];

                                                var score = 0;
                                                var highscore = 0;
                                                var speed = 6;
                                                var gameover = false;
                                                var pause = false;

                                                var last_update = 0;
                                                var last_draw = 0;

                                                console.log(snake_draw);

                                                generate_food(0);

                                                $('#snake-score').html(score);
                                                $('#snake-highscore').html(highscore);
                                                $('#snake-speed').html(Math.round(speed));

                                                window.addEventListener("keydown",
                                                    function(e){
                                                        keys[e.keyCode] = true;
                                                    },
                                                false);

                                                window.addEventListener("keyup",
                                                    function(e){
                                                        keys[e.keyCode] = false;
                                                    },
                                                false);

                                                $(window).click(function() {
                                                    pause = true;
                                                });

                                                $('#snake-canvas').click(function(e) {
                                                    pause = false;
                                                    e.stopPropagation();
                                                });

                                                function restart()
                                                {
                                                    snake = [{x:Math.round(board_size.x * 0.5),y:Math.round(board_size.y * 0.5)},{x:0,y:0},{x:0,y:0},{x:0,y:0}];
                                                    //snake_draw = snake.slice();
                                                    food = [{x:10,y:20}];
                                                    snake_direction = {x:0,y:0};
                                                    score = 0;
                                                    speed = 15;
                                                    gameover = false;

                                                    generate_food(0);

                                                    $('#snake-score').html(score);
                                                    $('#snake-highscore').html(highscore);
                                                    $('#snake-speed').html(Math.round(speed));
                                                }

                                                function generate_food(index)
                                                {
                                                    food[index] = {x: Math.floor(Math.random() * board_size.x), y: Math.floor(Math.random() * board_size.y)};
                                                }
                                                
                                                function input()
                                                {
                                                    if (!gameover)
                                                    {
                                                        if(keys[65] && snake_direction.x != 1) 
                                                            snake_direction = {x:-1,y:0};
                                                        if(keys[68] && snake_direction.x != -1) 
                                                            snake_direction = {x:1,y:0};
                                                        if(keys[87] && snake_direction.y != 1) 
                                                            snake_direction = {x:0,y:-1};
                                                        if(keys[83] && snake_direction.y != -1) 
                                                            snake_direction = {x:0,y:1};
                                                    }
                                                    else if(keys[27]) 
                                                        restart();
                                                }

                                                var interval = 0;
                                                function update(cur_time, dt)
                                                {
                                                    if (!gameover && !pause)
                                                    {
                                                        if (interval < 0)
                                                        {
                                                            interval += (1 / speed);
                                                            last_update = cur_time;

                                                            for (var i = snake.length - 1; i >= 0; i--) {
                                                                var cell = snake[i];

                                                                snake_draw[i] = {x:cell.x,y:cell.y};
       
                                                                if (i != 0)
                                                                {
                                                                    cell.x = snake[i - 1].x;
                                                                    cell.y = snake[i - 1].y;
                                                                }
                                                                else
                                                                {
                                                                    for (var f = 0; f < food.length; f++) {
                                                                        var food_cell = food[f];
                                                                        
                                                                        if (food_cell.x == cell.x && food_cell.y == cell.y)
                                                                        {
                                                                            food[f] = {x: Math.floor(Math.random() * board_size.x), y: Math.floor(Math.random() * board_size.y)};
                                                                            snake.push({x:snake[0].x,y:snake[0].y});
                                                                            //snake_draw = snake.slice();

                                                                            score += 1;
                                                                            $('#snake-score').html(score);
                                                                            speed += 0.1;
                                                                            $('#snake-speed').html(Math.round(speed));

                                                                            if (score > highscore)
                                                                            {
                                                                                highscore = score;
                                                                                $('#snake-highscore').html(highscore);
                                                                            }
                                                                        }
                                                                    }

                                                                    cell.x += snake_direction.x;
                                                                    cell.y += snake_direction.y;

                                                                    if (cell.x >= board_size.x)
                                                                        cell.x = 0;
                                                                    else if (cell.x < 0)
                                                                        cell.x = board_size.x;

                                                                    if (cell.y >= board_size.y)
                                                                        cell.y = 0;
                                                                    else if (cell.y < 0)
                                                                        cell.y = board_size.y;

                                                                    snake.forEach(function(snake_cell) {
                                                                        if (!(snake_direction.x == 0 && snake_direction.y == 0))
                                                                            if (snake_cell != cell && snake_cell.x == cell.x && snake_cell.y == cell.y)
                                                                                gameover = true;
                                                                    }, this);
                                                                }
                                                            }
                                                        }
                                                        else
                                                            interval -= dt;
                                                    }
                                                }

                                                function draw(cur_time, dt)
                                                {
                                                    last_draw = cur_time;
                                                    
                                                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                                                    if (!gameover)
                                                    {
                                                        if (!pause)
                                                        {
                                                            ctx.textAlign="start"; 
                                                            ctx.font = '12px Arial';
                                                            ctx.fillStyle="#444";
                                                            ctx.fillText(Math.round(1 / dt) + ' fps',10,20);

                                                            ctx.beginPath();
                                                            ctx.fillStyle="#44AA44";
                                                            food.forEach(function(food_cell) {
                                                                ctx.rect(food_cell.x * scale.x, food_cell.y * scale.y,scale.x - 1,scale.y - 1);
                                                                ctx.fill();
                                                            }, this);
                                                            ctx.closePath();
                                                            
                                                            
                                                            ctx.fillStyle="#444";
                                                            for (var i = 0; i < snake.length; i++) {
                                                                if (snake_draw[i] == null)
                                                                    snake_draw[i] = {x:0,y:0};
                                                                
                                                                var delta_t = (1 / speed);
                                                                var progress = ((last_draw - last_update) / delta_t) * 0.001;
                                                                //console.log(progress);

                                                                cell = snake[i];
                                                                cell_draw = snake_draw[i];

                                                                ctx.beginPath();
                                                                ctx.arc( (cell_draw.x + ( (cell.x - cell_draw.x) * progress )) * scale.x + (scale.x * 0.5), (cell_draw.y + ( (cell.y - cell_draw.y) * progress )) * scale.y + (scale.y * 0.5), scale.x * 0.5, 0, 2*Math.PI);//scale.x - 1,scale.y - 1);
                                                                ctx.fill();
                                                                ctx.closePath();
                                                            }
                                                            

                                                            // ctx.beginPath();
                                                            // ctx.fillStyle="#f00";
                                                            // snake.forEach(function(cell) {
                                                            //     ctx.rect(cell.x * scale.x + 2, cell.y * scale.y + 2, scale.x - 5,scale.y - 5);
                                                            //     ctx.fill();
                                                            // }, this);
                                                            // ctx.closePath();
                                                        }
                                                        else
                                                        {
                                                            ctx.fillStyle="#444";
                                                            ctx.textAlign="center"; 
                                                            ctx.font = '24px Arial';
                                                            ctx.fillText('Paused',200,200);
                                                            ctx.font = '14px Arial';
                                                            ctx.fillText('(Click to unpause)',200,220);
                                                        }
                                                    }
                                                    else
                                                    {
                                                        ctx.fillStyle="#444";
                                                        ctx.textAlign="center"; 
                                                        ctx.font = '24px Arial';
                                                        ctx.fillText('Game Over!',200,200);
                                                        ctx.font = '14px Arial';
                                                        ctx.fillText('(Press ESC to start a new game)',200,220);
                                                    }
                                                }

                                                var last_time = 0;
                                                function loop(cur_time)
                                                {
                                                    var dt = (cur_time - last_time) * 0.001;
                                                    last_time = cur_time;

                                                    input();
                                                    update(cur_time, dt);
                                                    draw(cur_time, dt);

                                                    window.requestAnimationFrame(loop);
                                                }
                                                window.requestAnimationFrame(loop);
                                            });
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <? renderPartial('pages/page_footers/home') ?>
        </div>
    </body>
</html>